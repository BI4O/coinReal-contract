# CoinReal的代码梳理v2

## 前端工程师指南：使用viem连接到App.sol合约

### 概述

本文档旨在指导前端工程师如何使用viem库连接到部署在Anvil上的App.sol合约。App.sol是CoinReal项目的核心合约，它整合了用户管理、话题管理和动作管理等功能。

### 合约架构

| 合约名称 | 功能描述 |
| ------- | ------- |
| **App.sol** | **核心入口合约**，整合所有子系统，提供统一的前端接口 |
| **UserManager.sol** | 用户管理系统，包括注册、查询、更新和删除用户 |
| **TopicManager.sol** | 话题和活动管理系统，继承TopicItem，管理话题和活动生命周期 |
| **ActionManager.sol** | 评论和点赞动作管理系统，集成AI标签和奖励机制 |
| **Campaign.sol** | 活动代币合约（ERC20），管理活动的奖励分配 |
| **CampaignFactory.sol** | 活动代币工厂，使用最小代理模式创建活动代币 |
| **ProjectToken.sol** | 项目代币，用于活动注资 |
| **USDC.sol** | 模拟USDC代币，用于活动注资 |
| **TimeSerLinkArray.sol** | 时间序列链表，维护用户活动历史 |
| **CountSerLinkArray.sol** | 点赞数排序链表，维护评论排行 |
| **Chainlink集成** | 包括VRF抽奖、Functions AI标签、Automation自动化 |

### 使用viem连接到App.sol合约

#### 1. 安装viem

```bash
pnpm install viem
```

#### 2. 配置viem客户端

```typescript
import { createPublicClient, http, createWalletClient, custom } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { anvilLocalnet } from 'viem/chains';

// 配置公共客户端
const publicClient = createPublicClient({
  chain: anvilLocalnet,
  transport: http('http://localhost:8545')
});

// 配置钱包客户端（使用MetaMask）
const walletClient = createWalletClient({
  chain: anvilLocalnet,
  transport: custom(window.ethereum)
});

// 如果使用私钥直接连接（开发环境）
const privateKey = '0x...'; // 你的私钥
const account = privateKeyToAccount(privateKey);

const walletClientWithAccount = createWalletClient({
  chain: anvilLocalnet,
  transport: http('http://localhost:8545'),
  account
});
```

#### 3. 定义合约ABI

```typescript
// App.sol的ABI
const appAbi = [
  // 用户管理
  {
    "inputs": [
      {"internalType": "string", "name": "_name", "type": "string"},
      {"internalType": "string", "name": "_bio", "type": "string"},
      {"internalType": "string", "name": "_email", "type": "string"}
    ],
    "name": "registerUser",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 话题管理
  {
    "inputs": [
      {"internalType": "string", "name": "_name", "type": "string"},
      {"internalType": "string", "name": "_description", "type": "string"},
      {"internalType": "string", "name": "_tokenAddress", "type": "string"},
      {"internalType": "uint256", "name": "_tokenPrice", "type": "uint256"}
    ],
    "name": "registerTopic",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 活动管理
  {
    "inputs": [
      {"internalType": "address", "name": "_sponsor", "type": "address"},
      {"internalType": "uint256", "name": "_topicId", "type": "uint256"},
      {"internalType": "string", "name": "_name", "type": "string"},
      {"internalType": "string", "name": "_description", "type": "string"},
      {"internalType": "address", "name": "_projectTokenAddr", "type": "address"}
    ],
    "name": "registerCampaign",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 活动注资
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"},
      {"internalType": "uint256", "name": "_amount", "type": "uint256"}
    ],
    "name": "fundCampaignWithUSDC",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"},
      {"internalType": "uint256", "name": "_amount", "type": "uint256"}
    ],
    "name": "fundCampaignWithProjectToken",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 活动开始/结束
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"},
      {"internalType": "uint256", "name": "_endTime", "type": "uint256"}
    ],
    "name": "startCampaign",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"}
    ],
    "name": "endCampaign",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 点赞和评论
  {
    "inputs": [
      {"internalType": "uint256", "name": "_topicId", "type": "uint256"},
      {"internalType": "uint256", "name": "_commentId", "type": "uint256"}
    ],
    "name": "like",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "_topicId", "type": "uint256"},
      {"internalType": "string", "name": "_content", "type": "string"}
    ],
    "name": "comment",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 查询功能
  {
    "inputs": [
      {"internalType": "address", "name": "_userAddress", "type": "address"},
      {"internalType": "uint256", "name": "_n", "type": "uint256"}
    ],
    "name": "getUserRecentComments",
    "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "address", "name": "_userAddress", "type": "address"},
      {"internalType": "uint256", "name": "_n", "type": "uint256"}
    ],
    "name": "getUserRecentLikes",
    "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "_n", "type": "uint256"}],
    "name": "getMostLikedComments",
    "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "_n", "type": "uint256"}],
    "name": "getLeastLikedComments",
    "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "startIndex", "type": "uint256"},
      {"internalType": "uint256", "name": "length", "type": "uint256"}
    ],
    "name": "getMostLikedCommentsPaginated",
    "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "startIndex", "type": "uint256"},
      {"internalType": "uint256", "name": "length", "type": "uint256"}
    ],
    "name": "getLeastLikedCommentsPaginated",
    "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getValidCommentsCount",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "_commentId", "type": "uint256"}],
    "name": "getComment",
    "outputs": [{
      "components": [
        {"internalType": "uint256", "name": "id", "type": "uint256"},
        {"internalType": "address", "name": "user", "type": "address"},
        {"internalType": "uint256", "name": "topicId", "type": "uint256"},
        {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
        {"internalType": "uint256", "name": "likeCount", "type": "uint256"},
        {"internalType": "bool", "name": "isDelete", "type": "bool"},
        {"internalType": "string", "name": "content", "type": "string"},
        {"internalType": "string[]", "name": "tags", "type": "string[]"}
      ],
      "internalType": "struct ActionManager.Comment",
      "name": "",
      "type": "tuple"
    }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "_likeId", "type": "uint256"}],
    "name": "getLike",
    "outputs": [{
      "components": [
        {"internalType": "uint256", "name": "id", "type": "uint256"},
        {"internalType": "address", "name": "user", "type": "address"},
        {"internalType": "uint256", "name": "topicId", "type": "uint256"},
        {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
        {"internalType": "uint256", "name": "commentId", "type": "uint256"},
        {"internalType": "bool", "name": "isCancel", "type": "bool"}
      ],
      "internalType": "struct ActionManager.Like",
      "name": "",
      "type": "tuple"
    }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "_commentId", "type": "uint256"}],
    "name": "getCommentLikeCount",
    "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "_commentId", "type": "uint256"}],
    "name": "getCommentTags",
    "outputs": [{"internalType": "string[]", "name": "", "type": "string[]"}],
    "stateMutability": "view",
    "type": "function"
  },
  // 管理功能
  {
    "inputs": [
      {"internalType": "uint256", "name": "_commentId", "type": "uint256"},
      {"internalType": "string[]", "name": "_tags", "type": "string[]"}
    ],
    "name": "addCommentTags",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "_commentId", "type": "uint256"}],
    "name": "deleteComment",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // AI标签功能
  {
    "inputs": [
      {"internalType": "uint256", "name": "commentId", "type": "uint256"}
    ],
    "name": "addCommentAITag",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "commentId", "type": "uint256"}
    ],
    "name": "getCommentAITag",
    "outputs": [{"internalType": "string", "name": "", "type": "string"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "commentId", "type": "uint256"}
    ],
    "name": "isCommentTagAnalyzed",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "view",
    "type": "function"
  },
  // 抽奖功能
  {
    "inputs": [
      {"internalType": "uint256", "name": "campaignId", "type": "uint256"}
    ],
    "name": "performCampaignLottery",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "campaignId", "type": "uint256"}
    ],
    "name": "checkCampaignLotteryNeeded",
    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
    "stateMutability": "view",
    "type": "function"
  },
  // 奖励查询
  {
    "inputs": [
      {"internalType": "uint256", "name": "campaignId", "type": "uint256"},
      {"internalType": "address", "name": "user", "type": "address"}
    ],
    "name": "getExpectedReward",
    "outputs": [
      {"internalType": "uint256[2]", "name": "", "type": "uint256[2]"},
      {"internalType": "uint256[2]", "name": "", "type": "uint256[2]"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "campaignId", "type": "uint256"}
    ],
    "name": "getFundPoolInfo",
    "outputs": [
      {"internalType": "uint256[3]", "name": "", "type": "uint256[3]"},
      {"internalType": "uint256[3]", "name": "", "type": "uint256[3]"},
      {"internalType": "uint256[3]", "name": "", "type": "uint256[3]"}
    ],
    "stateMutability": "view",
    "type": "function"
  },
  // 获取合约地址
  {
    "inputs": [],
    "name": "userManager",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "topicManager",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "actionManager",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "usdc",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "projectToken",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "campaignFactory",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  }
];

// 其他合约的ABI也需要类似定义
```

#### 4. 与合约交互

##### 4.1 初始化合约实例

```typescript
const appContractAddress = '0x...'; // App合约地址

// 读取合约数据
async function getContractData() {
  // 获取UserManager地址
  const userManagerAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'userManager'
  });
  
  console.log('UserManager地址:', userManagerAddress);
  
  // 类似地获取其他管理合约地址
}
```

##### 4.2 用户注册

```typescript
async function registerUser(name, bio, email) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'registerUser',
    args: [name, bio, email],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('交易已确认:', receipt);
}
```

##### 4.3 获取用户信息

```typescript
async function getUserInfo(userAddress) {
  // 首先获取UserManager地址
  const userManagerAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'userManager'
  });
  
  // 定义UserManager的ABI
  const userManagerAbi = [
    {
      "inputs": [{"internalType": "address", "name": "_user", "type": "address"}],
      "name": "getUserInfo",
      "outputs": [{
        "components": [
          {"internalType": "uint256", "name": "id", "type": "uint256"},
          {"internalType": "string", "name": "name", "type": "string"},
          {"internalType": "string", "name": "bio", "type": "string"},
          {"internalType": "string", "name": "email", "type": "string"},
          {"internalType": "bool", "name": "registered", "type": "bool"}
        ],
        "internalType": "struct UserManager.User",
        "name": "",
        "type": "tuple"
      }],
      "stateMutability": "view",
      "type": "function"
    }
  ];
  
  // 调用UserManager合约获取用户信息
  const userInfo = await publicClient.readContract({
    address: userManagerAddress,
    abi: userManagerAbi,
    functionName: 'getUserInfo',
    args: [userAddress]
  });
  
  return userInfo;
}
```

##### 4.4 获取话题列表

```typescript
async function getTopicsList() {
  // 首先获取TopicManager地址
  const topicManagerAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'topicManager'
  });
  
  // 定义TopicManager的ABI
  const topicManagerAbi = [
    {
      "inputs": [],
      "name": "listTopics",
      "outputs": [{
        "components": [
          {"internalType": "uint256", "name": "id", "type": "uint256"},
          {"internalType": "string", "name": "name", "type": "string"},
          {"internalType": "string", "name": "description", "type": "string"},
          {"internalType": "string", "name": "tokenAddress", "type": "string"},
          {"internalType": "uint256", "name": "tokenPrice", "type": "uint256"},
          {"internalType": "address", "name": "dataFeed", "type": "address"},
          {"internalType": "uint256", "name": "commentCount", "type": "uint256"},
          {"internalType": "uint256", "name": "likeCount", "type": "uint256"}
        ],
        "internalType": "struct TopicItem.Topic[]",
        "name": "",
        "type": "tuple[]"
      }],
      "stateMutability": "view",
      "type": "function"
    }
  ];
  
  // 调用TopicManager合约获取话题列表
  const topics = await publicClient.readContract({
    address: topicManagerAddress,
    abi: topicManagerAbi,
    functionName: 'listTopics'
  });
  
  return topics;
}
```

##### 4.5 发表评论

```typescript
async function postComment(topicId, content) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'comment',
    args: [topicId, content],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('评论交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('评论已确认:', receipt);
}
```

##### 4.6 点赞评论

```typescript
async function likeComment(topicId, commentId) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'like',
    args: [topicId, commentId],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('点赞交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('点赞已确认:', receipt);
}
```

##### 4.7 创建活动

```typescript
async function createCampaign(sponsor, topicId, name, description, projectTokenAddr) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'registerCampaign',
    args: [sponsor, topicId, name, description, projectTokenAddr],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('创建活动交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('活动已创建:', receipt);
}
```

##### 4.8 活动注资

```typescript
async function fundCampaignWithUSDC(campaignId, amount) {
  // 首先获取USDC地址
  const usdcAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'usdc'
  });
  
  // 定义USDC的ABI
  const usdcAbi = [
    {
      "inputs": [
        {"internalType": "address", "name": "spender", "type": "address"},
        {"internalType": "uint256", "name": "amount", "type": "uint256"}
      ],
      "name": "approve",
      "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];
  
  // 首先批准App合约使用USDC
  const { request: approveRequest } = await publicClient.simulateContract({
    address: usdcAddress,
    abi: usdcAbi,
    functionName: 'approve',
    args: [appContractAddress, amount],
    account: walletClient.account
  });
  
  const approveHash = await walletClient.writeContract(approveRequest);
  await publicClient.waitForTransactionReceipt({ hash: approveHash });
  
  // 然后调用注资函数
  const { request: fundRequest } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'fundCampaignWithUSDC',
    args: [campaignId, amount],
    account: walletClient.account
  });
  
  const fundHash = await walletClient.writeContract(fundRequest);
  console.log('注资交易哈希:', fundHash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash: fundHash });
  console.log('注资已确认:', receipt);
}
```

##### 4.9 启动活动

```typescript
async function startCampaign(campaignId, endTime) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'startCampaign',
    args: [campaignId, endTime],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('启动活动交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('活动已启动:', receipt);
}
```

##### 4.10 结束活动

```typescript
async function endCampaign(campaignId) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'endCampaign',
    args: [campaignId],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('结束活动交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('活动已结束:', receipt);
}
```

#### 5. 新增查询功能

##### 5.1 获取用户最近评论

```typescript
async function getUserRecentComments(userAddress, count) {
  const recentComments = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getUserRecentComments',
    args: [userAddress, count]
  });
  
  console.log('用户最近评论ID:', recentComments);
  return recentComments;
}
```

##### 5.2 获取用户最近点赞

```typescript
async function getUserRecentLikes(userAddress, count) {
  const recentLikes = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getUserRecentLikes',
    args: [userAddress, count]
  });
  
  console.log('用户最近点赞ID:', recentLikes);
  return recentLikes;
}
```

##### 5.3 获取最多点赞的评论

```typescript
async function getMostLikedComments(count) {
  const mostLiked = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getMostLikedComments',
    args: [count]
  });
  
  console.log('最多点赞评论ID:', mostLiked);
  return mostLiked;
}
```

##### 5.4 分页获取最多点赞的评论

```typescript
async function getMostLikedCommentsPaginated(startIndex, length) {
  const paginatedComments = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getMostLikedCommentsPaginated',
    args: [startIndex, length]
  });
  
  console.log('分页评论ID:', paginatedComments);
  return paginatedComments;
}
```

##### 5.5 获取有效评论总数

```typescript
async function getValidCommentsCount() {
  const count = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getValidCommentsCount'
  });
  
  console.log('有效评论总数:', count);
  return count;
}
```

##### 5.6 获取评论详情

```typescript
async function getCommentDetails(commentId) {
  const comment = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getComment',
    args: [commentId]
  });
  
  console.log('评论详情:', {
    id: comment.id,
    user: comment.user,
    topicId: comment.topicId,
    timestamp: new Date(Number(comment.timestamp) * 1000),
    likeCount: comment.likeCount,
    isDeleted: comment.isDelete,
    content: comment.content,
    tags: comment.tags
  });
  
  return comment;
}
```

##### 5.7 获取点赞详情

```typescript
async function getLikeDetails(likeId) {
  const like = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getLike',
    args: [likeId]
  });
  
  console.log('点赞详情:', {
    id: like.id,
    user: like.user,
    topicId: like.topicId,
    timestamp: new Date(Number(like.timestamp) * 1000),
    commentId: like.commentId,
    isCanceled: like.isCancel
  });
  
  return like;
}
```

##### 5.8 管理员添加评论标签

```typescript
async function addCommentTags(commentId, tags) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'addCommentTags',
    args: [commentId, tags],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('添加标签交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('标签已添加:', receipt);
}
```

##### 5.9 删除评论

```typescript
async function deleteComment(commentId) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'deleteComment',
    args: [commentId],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('删除评论交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('评论已删除:', receipt);
}
```

##### 5.10 AI标签功能

```typescript
// 为评论添加AI情感分析标签
async function addCommentAITag(commentId) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'addCommentAITag',
    args: [commentId],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('AI标签请求交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('AI标签请求已发送:', receipt);
}

// 获取评论的AI情感标签
async function getCommentAITag(commentId) {
  const tag = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getCommentAITag',
    args: [commentId]
  });
  
  console.log('AI标签:', tag); // POS/NEG/NEU
  return tag;
}

// 检查评论是否已完成AI分析
async function isCommentTagAnalyzed(commentId) {
  const analyzed = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'isCommentTagAnalyzed',
    args: [commentId]
  });
  
  return analyzed;
}
```

##### 5.11 活动抽奖功能

```typescript
// 执行活动抽奖
async function performCampaignLottery(campaignId) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'performCampaignLottery',
    args: [campaignId],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('抽奖交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('抽奖已完成:', receipt);
}

// 检查活动是否需要执行抽奖
async function checkCampaignLotteryNeeded(campaignId) {
  const needed = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'checkCampaignLotteryNeeded',
    args: [campaignId]
  });
  
  return needed;
}
```

##### 5.12 奖励查询功能

```typescript
// 获取用户预期奖励
async function getExpectedReward(campaignId, userAddress) {
  const rewards = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getExpectedReward',
    args: [campaignId, userAddress]
  });
  
  const [worstCase, bestCase] = rewards;
  console.log('最差情况奖励 [USDC, ProjectToken]:', worstCase);
  console.log('最好情况奖励 [USDC, ProjectToken]:', bestCase);
  
  return { worstCase, bestCase };
}

// 获取活动奖池信息
async function getFundPoolInfo(campaignId) {
  const poolInfo = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'getFundPoolInfo',
    args: [campaignId]
  });
  
  const [qualityPool, lotteryPool, campaignPool] = poolInfo;
  console.log('质量评论者奖池 [人数, USDC, ProjectToken]:', qualityPool);
  console.log('点赞抽奖奖池 [人数, USDC, ProjectToken]:', lotteryPool);
  console.log('CampaignToken奖池 [总参与者, USDC, ProjectToken]:', campaignPool);
  
  return { qualityPool, lotteryPool, campaignPool };
}
```

#### 5. 监听合约事件

虽然App.sol合约本身没有定义事件，但我们可以监听交易确认来跟踪操作的完成：

```typescript
async function watchTransactionConfirmation(hash) {
  const unwatch = publicClient.watchTransactionReceipt(
    { hash },
    (receipt) => {
      console.log('交易已确认:', receipt);
      unwatch(); // 停止监听
    }
  );
}
```

#### 6. 完整的React集成示例

```tsx
import React, { useState, useEffect } from 'react';
import { createPublicClient, http, createWalletClient, custom } from 'viem';
import { anvilLocalnet } from 'viem/chains';

// 配置客户端
const publicClient = createPublicClient({
  chain: anvilLocalnet,
  transport: http('http://localhost:8545')
});

const walletClient = createWalletClient({
  chain: anvilLocalnet,
  transport: custom(window.ethereum)
});

// App合约ABI和地址
const appAbi = [...]; // 完整的ABI定义
const appContractAddress = '0x...'; // 部署的App合约地址

function CoinRealApp() {
  const [account, setAccount] = useState(null);
  const [topics, setTopics] = useState([]);
  const [userInfo, setUserInfo] = useState(null);
  const [loading, setLoading] = useState(false);
  const [userComments, setUserComments] = useState([]);
  const [userLikes, setUserLikes] = useState([]);
  const [mostLikedComments, setMostLikedComments] = useState([]);
  const [commentsPage, setCommentsPage] = useState(0);
  const [totalComments, setTotalComments] = useState(0);
  
  // 连接钱包
  async function connectWallet() {
    try {
      const [address] = await window.ethereum.request({ method: 'eth_requestAccounts' });
      setAccount(address);
      
      // 获取用户信息
      if (address) {
        const info = await getUserInfo(address);
        setUserInfo(info);
      }
    } catch (error) {
      console.error('连接钱包失败:', error);
    }
  }
  
  // 获取用户信息
  async function getUserInfo(address) {
    try {
      const userManagerAddress = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'userManager'
      });
      
      const userManagerAbi = [...]; // UserManager的ABI
      
      const info = await publicClient.readContract({
        address: userManagerAddress,
        abi: userManagerAbi,
        functionName: 'getUserInfo',
        args: [address]
      });
      
      return info;
    } catch (error) {
      console.error('获取用户信息失败:', error);
      return null;
    }
  }
  
  // 获取话题列表
  async function fetchTopics() {
    try {
      setLoading(true);
      const topicManagerAddress = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'topicManager'
      });
      
      const topicManagerAbi = [...]; // TopicManager的ABI
      
      const topicsList = await publicClient.readContract({
        address: topicManagerAddress,
        abi: topicManagerAbi,
        functionName: 'listTopics'
      });
      
      setTopics(topicsList);
    } catch (error) {
      console.error('获取话题列表失败:', error);
    } finally {
      setLoading(false);
    }
  }
  
  // 注册用户
  async function handleRegisterUser(name, bio, email) {
    try {
      setLoading(true);
      
      const { request } = await publicClient.simulateContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'registerUser',
        args: [name, bio, email],
        account
      });
      
      const hash = await walletClient.writeContract(request);
      console.log('注册用户交易哈希:', hash);
      
      // 等待交易确认
      const receipt = await publicClient.waitForTransactionReceipt({ hash });
      console.log('用户注册已确认:', receipt);
      
      // 更新用户信息
      const info = await getUserInfo(account);
      setUserInfo(info);
    } catch (error) {
      console.error('注册用户失败:', error);
    } finally {
      setLoading(false);
    }
  }
  
  // 发表评论
  async function handlePostComment(topicId, content) {
    try {
      setLoading(true);
      
      const { request } = await publicClient.simulateContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'comment',
        args: [topicId, content],
        account
      });
      
      const hash = await walletClient.writeContract(request);
      console.log('评论交易哈希:', hash);
      
      // 等待交易确认
      const receipt = await publicClient.waitForTransactionReceipt({ hash });
      console.log('评论已确认:', receipt);
      
      // 刷新话题列表
      fetchTopics();
    } catch (error) {
      console.error('发表评论失败:', error);
    } finally {
      setLoading(false);
    }
  }
  
  // 获取用户活动历史
  async function fetchUserActivity() {
    if (!account) return;
    
    try {
      // 获取用户最近10个评论
      const recentComments = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'getUserRecentComments',
        args: [account, 10]
      });
      
      // 获取用户最近10个点赞
      const recentLikes = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'getUserRecentLikes',
        args: [account, 10]
      });
      
      setUserComments(recentComments);
      setUserLikes(recentLikes);
    } catch (error) {
      console.error('获取用户活动失败:', error);
    }
  }
  
  // 获取热门评论
  async function fetchMostLikedComments() {
    try {
      const mostLiked = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'getMostLikedComments',
        args: [10]
      });
      
      const total = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'getValidCommentsCount'
      });
      
      setMostLikedComments(mostLiked);
      setTotalComments(Number(total));
    } catch (error) {
      console.error('获取热门评论失败:', error);
    }
  }
  
  // 分页获取评论
  async function fetchCommentsPaginated(page = 0, pageSize = 10) {
    try {
      const startIndex = page * pageSize;
      const paginatedComments = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'getMostLikedCommentsPaginated',
        args: [startIndex, pageSize]
      });
      
      setMostLikedComments(paginatedComments);
      setCommentsPage(page);
    } catch (error) {
      console.error('分页获取评论失败:', error);
    }
  }
  
  // 获取评论详情
  async function getCommentDetails(commentId) {
    try {
      const comment = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'getComment',
        args: [commentId]
      });
      
      return {
        id: comment.id,
        user: comment.user,
        topicId: comment.topicId,
        timestamp: new Date(Number(comment.timestamp) * 1000),
        likeCount: comment.likeCount,
        isDeleted: comment.isDelete,
        content: comment.content,
        tags: comment.tags
      };
    } catch (error) {
      console.error('获取评论详情失败:', error);
      return null;
    }
  }
  
  // 删除评论
  async function handleDeleteComment(commentId) {
    try {
      setLoading(true);
      
      const { request } = await publicClient.simulateContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'deleteComment',
        args: [commentId],
        account
      });
      
      const hash = await walletClient.writeContract(request);
      console.log('删除评论交易哈希:', hash);
      
      // 等待交易确认
      const receipt = await publicClient.waitForTransactionReceipt({ hash });
      console.log('评论已删除:', receipt);
      
      // 刷新数据
      fetchUserActivity();
      fetchMostLikedComments();
    } catch (error) {
      console.error('删除评论失败:', error);
    } finally {
      setLoading(false);
    }
  }
  
  // 初始化加载
  useEffect(() => {
    connectWallet();
    fetchTopics();
    fetchMostLikedComments();
  }, []);
  
  // 当账户变化时获取用户活动
  useEffect(() => {
    if (account) {
      fetchUserActivity();
    }
  }, [account]);
  
  return (
    <div className="app">
      <header>
        <h1>CoinReal</h1>
        <div className="wallet">
          {account ? (
            <span>已连接: {account.substring(0, 6)}...{account.substring(38)}</span>
          ) : (
            <button onClick={connectWallet}>连接钱包</button>
          )}
        </div>
      </header>
      
      <main>
        {/* 用户信息 */}
        <section className="user-info">
          {userInfo ? (
            <div>
              <h2>{userInfo.name}</h2>
              <p>{userInfo.bio}</p>
              <p>{userInfo.email}</p>
            </div>
          ) : account ? (
            <div className="register-form">
              <h2>注册用户</h2>
              {/* 注册表单 */}
            </div>
          ) : (
            <p>请连接钱包</p>
          )}
        </section>
        
        {/* 用户活动历史 */}
        {account && userInfo && (
          <section className="user-activity">
            <h2>我的活动</h2>
            <div className="activity-tabs">
              <div className="comments-tab">
                <h3>最近评论 ({userComments.length})</h3>
                <ul>
                  {userComments.map((commentId) => (
                    <CommentItem 
                      key={commentId} 
                      commentId={commentId} 
                      onDelete={handleDeleteComment}
                      getDetails={getCommentDetails}
                    />
                  ))}
                </ul>
              </div>
              <div className="likes-tab">
                <h3>最近点赞 ({userLikes.length})</h3>
                <ul>
                  {userLikes.map((likeId) => (
                    <LikeItem 
                      key={likeId} 
                      likeId={likeId}
                    />
                  ))}
                </ul>
              </div>
            </div>
          </section>
        )}
        
        {/* 热门评论 */}
        <section className="hot-comments">
          <h2>热门评论</h2>
          <div className="pagination-controls">
            <button 
              onClick={() => fetchCommentsPaginated(commentsPage - 1)}
              disabled={commentsPage === 0}
            >
              上一页
            </button>
            <span>第 {commentsPage + 1} 页</span>
            <button 
              onClick={() => fetchCommentsPaginated(commentsPage + 1)}
              disabled={(commentsPage + 1) * 10 >= totalComments}
            >
              下一页
            </button>
            <span>总计 {totalComments} 条评论</span>
          </div>
          {loading ? (
            <p>加载中...</p>
          ) : (
            <ul>
              {mostLikedComments.map((commentId) => (
                <CommentItem 
                  key={commentId} 
                  commentId={commentId}
                  getDetails={getCommentDetails}
                  showActions={false}
                />
              ))}
            </ul>
          )}
        </section>
        
        {/* 话题列表 */}
        <section className="topics">
          <h2>话题列表</h2>
          {loading ? (
            <p>加载中...</p>
          ) : (
            <ul>
              {topics.map((topic) => (
                <li key={topic.id}>
                  <h3>{topic.name}</h3>
                  <p>{topic.description}</p>
                  <div>
                    <span>评论数: {topic.commentCount}</span>
                    <span>点赞数: {topic.likeCount}</span>
                  </div>
                  {/* 评论表单 */}
                </li>
              ))}
            </ul>
          )}
        </section>
      </main>
    </div>
  );
}

// 评论组件
function CommentItem({ commentId, onDelete, getDetails, showActions = true }) {
  const [comment, setComment] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    async function fetchComment() {
      const details = await getDetails(commentId);
      setComment(details);
      setLoading(false);
    }
    fetchComment();
  }, [commentId]);
  
  if (loading) return <li>加载中...</li>;
  if (!comment) return <li>评论不存在</li>;
  
  return (
    <li className="comment-item">
      <div className="comment-header">
        <span className="user">{comment.user.substring(0, 6)}...{comment.user.substring(38)}</span>
        <span className="timestamp">{comment.timestamp.toLocaleString()}</span>
        <span className="likes">👍 {comment.likeCount}</span>
      </div>
      <div className="comment-content">
        {comment.content}
      </div>
      {comment.tags.length > 0 && (
        <div className="comment-tags">
          {comment.tags.map((tag, index) => (
            <span key={index} className="tag">#{tag}</span>
          ))}
        </div>
      )}
      {showActions && (
        <div className="comment-actions">
          <button onClick={() => onDelete(commentId)}>删除</button>
        </div>
      )}
    </li>
  );
}

// 点赞组件
function LikeItem({ likeId }) {
  const [like, setLike] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    async function fetchLike() {
      try {
        const likeDetails = await publicClient.readContract({
          address: appContractAddress,
          abi: appAbi,
          functionName: 'getLike',
          args: [likeId]
        });
        
        setLike({
          id: likeDetails.id,
          user: likeDetails.user,
          topicId: likeDetails.topicId,
          timestamp: new Date(Number(likeDetails.timestamp) * 1000),
          commentId: likeDetails.commentId,
          isCanceled: likeDetails.isCancel
        });
      } catch (error) {
        console.error('获取点赞详情失败:', error);
      } finally {
        setLoading(false);
      }
    }
    fetchLike();
  }, [likeId]);
  
  if (loading) return <li>加载中...</li>;
  if (!like) return <li>点赞不存在</li>;
  
  return (
    <li className="like-item">
      <div className="like-info">
        <span>点赞了评论 #{like.commentId}</span>
        <span className="timestamp">{like.timestamp.toLocaleString()}</span>
      </div>
    </li>
  );
}

export default CoinRealApp;
```

### 新增功能总结

#### 用户活动追踪
- **getUserRecentComments**: 获取用户最近的评论历史
- **getUserRecentLikes**: 获取用户最近的点赞历史
- 基于TimeSerLinkArray链表实现，O(1)时间复杂度添加，高效查询最近活动

#### 评论排行功能
- **getMostLikedComments**: 获取点赞数最多的评论
- **getLeastLikedComments**: 获取点赞数最少的评论
- 基于CountSerLinkArray有序链表，自动过滤已删除评论
- 支持自定义返回数量和分页查询

#### 分页查询支持
- **getMostLikedCommentsPaginated**: 分页获取最多点赞评论
- **getRecentCommentsPaginated**: 分页获取最近评论（全局时间序列）
- **getValidCommentsCount**: 获取有效评论总数
- **getGlobalCommentsCount**: 获取全局评论总数
- 避免一次性返回大量数据，提高性能和用户体验

#### 详细信息查询
- **getComment**: 获取完整的评论信息（包括标签、点赞数等）
- **getLike**: 获取点赞的详细信息
- **getCommentTags**: 获取评论的标签列表
- **getCommentLikeCount**: 获取评论的点赞数

#### Chainlink集成功能
- **addCommentAITag**: 使用Chainlink Functions为评论添加AI情感分析标签
- **getCommentAITag**: 获取评论的AI情感标签（POS/NEG/NEU）
- **performCampaignLottery**: 使用Chainlink VRF执行活动随机抽奖
- **checkCampaignLotteryNeeded**: 检查活动是否需要执行抽奖
- 支持Chainlink Automation自动化批处理

#### 奖励系统查询
- **getExpectedReward**: 获取用户在特定活动中的预期奖励范围
- **getFundPoolInfo**: 获取活动的奖池分配信息
- 支持实时查询最差和最好情况下的奖励估算

#### 管理功能
- **addCommentTags**: 管理员可为评论添加标签
- **deleteComment**: 用户可删除自己的评论
- **withdrawPlatformFees**: 管理员提取平台费用
- 完整的权限控制和安全检查

#### 技术特点
1. **高效数据结构**: 
   - TimeSerLinkArray：时间序列双向链表，维护用户和全局活动历史
   - CountSerLinkArray：点赞数排序链表，支持动态更新和有序查询
2. **分页支持**: 避免gas消耗过高，支持灵活的分页查询
3. **Chainlink集成**: 
   - Functions：外部AI服务调用
   - VRF：安全随机数生成
   - Automation：自动化任务执行
4. **奖励机制**: 多层次奖励分配，包括评论奖励、点赞奖励、质量评论者奖励和抽奖奖励
5. **安全设计**: 完善的权限控制、重入攻击防护和错误处理
6. **可扩展性**: 模块化设计，易于添加新功能和集成第三方服务

### 总结

本文档详细介绍了如何使用viem库连接到部署在Anvil上的App.sol合约，包括配置客户端、定义合约ABI、与合约交互以及监听合约事件。

#### 更新后的主要功能亮点

1. **完整的社交系统**: 用户注册、评论、点赞，支持用户活动历史追踪
2. **高效的数据结构**: 
   - 时间序列链表维护用户和全局活动历史
   - 点赞数排序链表支持实时排行榜
3. **Chainlink深度集成**:
   - Functions：AI情感分析标签自动化
   - VRF：公平的随机抽奖机制
   - Automation：批处理和定时任务
4. **多层次奖励机制**:
   - 实时查询预期奖励范围
   - 质量评论者奖励分配
   - 点赞者随机抽奖
   - 按CP token比例分配奖池
5. **前端友好的设计**:
   - 分页查询避免数据过载
   - 统一的App.sol入口简化集成
   - 完整的错误处理和状态查询

通过这些升级，CoinReal不仅提供了完整的社交化DeFi基础设施，还集成了前沿的Web3技术，为构建下一代去中心化社交应用提供了强大的技术支撑。前端工程师可以通过本文档的指南，轻松实现从基础的用户交互到高级的AI分析和自动化功能的完整集成。
        

