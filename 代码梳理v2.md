# CoinReal的代码梳理v2

## 前端工程师指南：使用viem连接到App.sol合约

### 概述

本文档旨在指导前端工程师如何使用viem库连接到部署在Anvil上的App.sol合约。App.sol是CoinReal项目的核心合约，它整合了用户管理、话题管理和动作管理等功能。

### 合约架构

| 合约名称 | 功能描述 |
| ------- | ------- |
| App.sol | 核心合约，整合了用户、话题和动作管理功能 |
| UserManager.sol | 用户管理，包括注册、查询、更新和删除用户 |
| TopicManager.sol | 话题管理，包括注册话题、查询话题、更新话题价格和删除话题 |
| ActionManager.sol | 动作管理，包括评论和点赞功能 |
| Campaign.sol | 活动代币合约，管理活动的奖励机制 |
| CampaignFactory.sol | 活动代币工厂，用于创建新的活动代币 |
| ProjectToken.sol | 项目代币，用于活动注资 |
| USDC.sol | 模拟USDC代币，用于活动注资 |

### 使用viem连接到App.sol合约

#### 1. 安装viem

```bash
npm install viem
```

#### 2. 配置viem客户端

```typescript
import { createPublicClient, http, createWalletClient, custom } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { anvilLocalnet } from 'viem/chains';

// 配置公共客户端
const publicClient = createPublicClient({
  chain: anvilLocalnet,
  transport: http('http://localhost:8545')
});

// 配置钱包客户端（使用MetaMask）
const walletClient = createWalletClient({
  chain: anvilLocalnet,
  transport: custom(window.ethereum)
});

// 如果使用私钥直接连接（开发环境）
const privateKey = '0x...'; // 你的私钥
const account = privateKeyToAccount(privateKey);

const walletClientWithAccount = createWalletClient({
  chain: anvilLocalnet,
  transport: http('http://localhost:8545'),
  account
});
```

#### 3. 定义合约ABI

```typescript
// App.sol的ABI
const appAbi = [
  // 用户管理
  {
    "inputs": [
      {"internalType": "string", "name": "_name", "type": "string"},
      {"internalType": "string", "name": "_bio", "type": "string"},
      {"internalType": "string", "name": "_email", "type": "string"}
    ],
    "name": "registerUser",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 话题管理
  {
    "inputs": [
      {"internalType": "string", "name": "_name", "type": "string"},
      {"internalType": "string", "name": "_description", "type": "string"},
      {"internalType": "string", "name": "_tokenAddress", "type": "string"},
      {"internalType": "uint256", "name": "_tokenPrice", "type": "uint256"}
    ],
    "name": "registerTopic",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 活动管理
  {
    "inputs": [
      {"internalType": "address", "name": "_sponsor", "type": "address"},
      {"internalType": "uint256", "name": "_topicId", "type": "uint256"},
      {"internalType": "string", "name": "_name", "type": "string"},
      {"internalType": "string", "name": "_description", "type": "string"},
      {"internalType": "address", "name": "_projectTokenAddr", "type": "address"}
    ],
    "name": "registerCampaign",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 活动注资
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"},
      {"internalType": "uint256", "name": "_amount", "type": "uint256"}
    ],
    "name": "fundCampaignWithUSDC",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"},
      {"internalType": "uint256", "name": "_amount", "type": "uint256"}
    ],
    "name": "fundCampaignWithProjectToken",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 活动开始/结束
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"},
      {"internalType": "uint256", "name": "_endTime", "type": "uint256"}
    ],
    "name": "startCampaign",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "_campaignId", "type": "uint256"}
    ],
    "name": "endCampaign",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 点赞和评论
  {
    "inputs": [
      {"internalType": "uint256", "name": "_topicId", "type": "uint256"},
      {"internalType": "uint256", "name": "_commentId", "type": "uint256"}
    ],
    "name": "like",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "uint256", "name": "_topicId", "type": "uint256"},
      {"internalType": "string", "name": "_content", "type": "string"}
    ],
    "name": "comment",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // 获取合约地址
  {
    "inputs": [],
    "name": "userManager",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "topicManager",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "actionManager",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "usdc",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "projectToken",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "campaignFactory",
    "outputs": [{"internalType": "address", "name": "", "type": "address"}],
    "stateMutability": "view",
    "type": "function"
  }
];

// 其他合约的ABI也需要类似定义
```

#### 4. 与合约交互

##### 4.1 初始化合约实例

```typescript
const appContractAddress = '0x...'; // App合约地址

// 读取合约数据
async function getContractData() {
  // 获取UserManager地址
  const userManagerAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'userManager'
  });
  
  console.log('UserManager地址:', userManagerAddress);
  
  // 类似地获取其他管理合约地址
}
```

##### 4.2 用户注册

```typescript
async function registerUser(name, bio, email) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'registerUser',
    args: [name, bio, email],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('交易已确认:', receipt);
}
```

##### 4.3 获取用户信息

```typescript
async function getUserInfo(userAddress) {
  // 首先获取UserManager地址
  const userManagerAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'userManager'
  });
  
  // 定义UserManager的ABI
  const userManagerAbi = [
    {
      "inputs": [{"internalType": "address", "name": "_user", "type": "address"}],
      "name": "getUserInfo",
      "outputs": [{
        "components": [
          {"internalType": "uint256", "name": "id", "type": "uint256"},
          {"internalType": "string", "name": "name", "type": "string"},
          {"internalType": "string", "name": "bio", "type": "string"},
          {"internalType": "string", "name": "email", "type": "string"},
          {"internalType": "bool", "name": "registered", "type": "bool"}
        ],
        "internalType": "struct UserManager.User",
        "name": "",
        "type": "tuple"
      }],
      "stateMutability": "view",
      "type": "function"
    }
  ];
  
  // 调用UserManager合约获取用户信息
  const userInfo = await publicClient.readContract({
    address: userManagerAddress,
    abi: userManagerAbi,
    functionName: 'getUserInfo',
    args: [userAddress]
  });
  
  return userInfo;
}
```

##### 4.4 获取话题列表

```typescript
async function getTopicsList() {
  // 首先获取TopicManager地址
  const topicManagerAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'topicManager'
  });
  
  // 定义TopicManager的ABI
  const topicManagerAbi = [
    {
      "inputs": [],
      "name": "listTopics",
      "outputs": [{
        "components": [
          {"internalType": "uint256", "name": "id", "type": "uint256"},
          {"internalType": "string", "name": "name", "type": "string"},
          {"internalType": "string", "name": "description", "type": "string"},
          {"internalType": "string", "name": "tokenAddress", "type": "string"},
          {"internalType": "uint256", "name": "tokenPrice", "type": "uint256"},
          {"internalType": "address", "name": "dataFeed", "type": "address"},
          {"internalType": "uint256", "name": "commentCount", "type": "uint256"},
          {"internalType": "uint256", "name": "likeCount", "type": "uint256"}
        ],
        "internalType": "struct TopicItem.Topic[]",
        "name": "",
        "type": "tuple[]"
      }],
      "stateMutability": "view",
      "type": "function"
    }
  ];
  
  // 调用TopicManager合约获取话题列表
  const topics = await publicClient.readContract({
    address: topicManagerAddress,
    abi: topicManagerAbi,
    functionName: 'listTopics'
  });
  
  return topics;
}
```

##### 4.5 发表评论

```typescript
async function postComment(topicId, content) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'comment',
    args: [topicId, content],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('评论交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('评论已确认:', receipt);
}
```

##### 4.6 点赞评论

```typescript
async function likeComment(topicId, commentId) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'like',
    args: [topicId, commentId],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('点赞交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('点赞已确认:', receipt);
}
```

##### 4.7 创建活动

```typescript
async function createCampaign(sponsor, topicId, name, description, projectTokenAddr) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'registerCampaign',
    args: [sponsor, topicId, name, description, projectTokenAddr],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('创建活动交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('活动已创建:', receipt);
}
```

##### 4.8 活动注资

```typescript
async function fundCampaignWithUSDC(campaignId, amount) {
  // 首先获取USDC地址
  const usdcAddress = await publicClient.readContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'usdc'
  });
  
  // 定义USDC的ABI
  const usdcAbi = [
    {
      "inputs": [
        {"internalType": "address", "name": "spender", "type": "address"},
        {"internalType": "uint256", "name": "amount", "type": "uint256"}
      ],
      "name": "approve",
      "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];
  
  // 首先批准App合约使用USDC
  const { request: approveRequest } = await publicClient.simulateContract({
    address: usdcAddress,
    abi: usdcAbi,
    functionName: 'approve',
    args: [appContractAddress, amount],
    account: walletClient.account
  });
  
  const approveHash = await walletClient.writeContract(approveRequest);
  await publicClient.waitForTransactionReceipt({ hash: approveHash });
  
  // 然后调用注资函数
  const { request: fundRequest } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'fundCampaignWithUSDC',
    args: [campaignId, amount],
    account: walletClient.account
  });
  
  const fundHash = await walletClient.writeContract(fundRequest);
  console.log('注资交易哈希:', fundHash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash: fundHash });
  console.log('注资已确认:', receipt);
}
```

##### 4.9 启动活动

```typescript
async function startCampaign(campaignId, endTime) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'startCampaign',
    args: [campaignId, endTime],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('启动活动交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('活动已启动:', receipt);
}
```

##### 4.10 结束活动

```typescript
async function endCampaign(campaignId) {
  const { request } = await publicClient.simulateContract({
    address: appContractAddress,
    abi: appAbi,
    functionName: 'endCampaign',
    args: [campaignId],
    account: walletClient.account
  });
  
  const hash = await walletClient.writeContract(request);
  console.log('结束活动交易哈希:', hash);
  
  // 等待交易确认
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log('活动已结束:', receipt);
}
```

#### 5. 监听合约事件

虽然App.sol合约本身没有定义事件，但我们可以监听交易确认来跟踪操作的完成：

```typescript
async function watchTransactionConfirmation(hash) {
  const unwatch = publicClient.watchTransactionReceipt(
    { hash },
    (receipt) => {
      console.log('交易已确认:', receipt);
      unwatch(); // 停止监听
    }
  );
}
```

#### 6. 完整的React集成示例

```tsx
import React, { useState, useEffect } from 'react';
import { createPublicClient, http, createWalletClient, custom } from 'viem';
import { anvilLocalnet } from 'viem/chains';

// 配置客户端
const publicClient = createPublicClient({
  chain: anvilLocalnet,
  transport: http('http://localhost:8545')
});

const walletClient = createWalletClient({
  chain: anvilLocalnet,
  transport: custom(window.ethereum)
});

// App合约ABI和地址
const appAbi = [...]; // 完整的ABI定义
const appContractAddress = '0x...'; // 部署的App合约地址

function CoinRealApp() {
  const [account, setAccount] = useState(null);
  const [topics, setTopics] = useState([]);
  const [userInfo, setUserInfo] = useState(null);
  const [loading, setLoading] = useState(false);
  
  // 连接钱包
  async function connectWallet() {
    try {
      const [address] = await window.ethereum.request({ method: 'eth_requestAccounts' });
      setAccount(address);
      
      // 获取用户信息
      if (address) {
        const info = await getUserInfo(address);
        setUserInfo(info);
      }
    } catch (error) {
      console.error('连接钱包失败:', error);
    }
  }
  
  // 获取用户信息
  async function getUserInfo(address) {
    try {
      const userManagerAddress = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'userManager'
      });
      
      const userManagerAbi = [...]; // UserManager的ABI
      
      const info = await publicClient.readContract({
        address: userManagerAddress,
        abi: userManagerAbi,
        functionName: 'getUserInfo',
        args: [address]
      });
      
      return info;
    } catch (error) {
      console.error('获取用户信息失败:', error);
      return null;
    }
  }
  
  // 获取话题列表
  async function fetchTopics() {
    try {
      setLoading(true);
      const topicManagerAddress = await publicClient.readContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'topicManager'
      });
      
      const topicManagerAbi = [...]; // TopicManager的ABI
      
      const topicsList = await publicClient.readContract({
        address: topicManagerAddress,
        abi: topicManagerAbi,
        functionName: 'listTopics'
      });
      
      setTopics(topicsList);
    } catch (error) {
      console.error('获取话题列表失败:', error);
    } finally {
      setLoading(false);
    }
  }
  
  // 注册用户
  async function handleRegisterUser(name, bio, email) {
    try {
      setLoading(true);
      
      const { request } = await publicClient.simulateContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'registerUser',
        args: [name, bio, email],
        account
      });
      
      const hash = await walletClient.writeContract(request);
      console.log('注册用户交易哈希:', hash);
      
      // 等待交易确认
      const receipt = await publicClient.waitForTransactionReceipt({ hash });
      console.log('用户注册已确认:', receipt);
      
      // 更新用户信息
      const info = await getUserInfo(account);
      setUserInfo(info);
    } catch (error) {
      console.error('注册用户失败:', error);
    } finally {
      setLoading(false);
    }
  }
  
  // 发表评论
  async function handlePostComment(topicId, content) {
    try {
      setLoading(true);
      
      const { request } = await publicClient.simulateContract({
        address: appContractAddress,
        abi: appAbi,
        functionName: 'comment',
        args: [topicId, content],
        account
      });
      
      const hash = await walletClient.writeContract(request);
      console.log('评论交易哈希:', hash);
      
      // 等待交易确认
      const receipt = await publicClient.waitForTransactionReceipt({ hash });
      console.log('评论已确认:', receipt);
      
      // 刷新话题列表
      fetchTopics();
    } catch (error) {
      console.error('发表评论失败:', error);
    } finally {
      setLoading(false);
    }
  }
  
  // 初始化加载
  useEffect(() => {
    connectWallet();
    fetchTopics();
  }, []);
  
  return (
    <div className="app">
      <header>
        <h1>CoinReal</h1>
        <div className="wallet">
          {account ? (
            <span>已连接: {account.substring(0, 6)}...{account.substring(38)}</span>
          ) : (
            <button onClick={connectWallet}>连接钱包</button>
          )}
        </div>
      </header>
      
      <main>
        {/* 用户信息 */}
        <section className="user-info">
          {userInfo ? (
            <div>
              <h2>{userInfo.name}</h2>
              <p>{userInfo.bio}</p>
              <p>{userInfo.email}</p>
            </div>
          ) : account ? (
            <div className="register-form">
              <h2>注册用户</h2>
              {/* 注册表单 */}
            </div>
          ) : (
            <p>请连接钱包</p>
          )}
        </section>
        
        {/* 话题列表 */}
        <section className="topics">
          <h2>话题列表</h2>
          {loading ? (
            <p>加载中...</p>
          ) : (
            <ul>
              {topics.map((topic) => (
                <li key={topic.id}>
                  <h3>{topic.name}</h3>
                  <p>{topic.description}</p>
                  <div>
                    <span>评论数: {topic.commentCount}</span>
                    <span>点赞数: {topic.likeCount}</span>
                  </div>
                  {/* 评论表单 */}
                </li>
              ))}
            </ul>
          )}
        </section>
      </main>
    </div>
  );
}

export default CoinRealApp;
```

### 总结

本文档详细介绍了如何使用viem库连接到部署在Anvil上的App.sol合约，包括配置客户端、定义合约ABI、与合约交互以及监听合约事件。通过这些指南，前端工程师可以轻松地将CoinReal项目的智能合约功能集成到前端应用中。
        

